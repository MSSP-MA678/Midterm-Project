---
title: "Report of MA678 Midterm Project"
author: "Kosuke Sasaki"
date: "2021/12/11"
output:
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
Sys.setenv("LANGUAGE" = "EN")
Sys.setlocale("LC_ALL", "C")
library(openxlsx)
library(ggmosaic)
library(tidyverse)
library(stringr)
library(rstanarm)
library(knitr)
library(magrittr)
library(kableExtra)
library(gridExtra)
library(tidytext)
library(lubridate)
library(car) 
library(gvlma)
library(lme4)
library(arm)
library(lmerTest)
library(lattice)
library(ggplot2)
library(scales)
eco <- read.xlsx("Final dataset original.xlsx",sheet=1)
```

## Abstract

Autism spectrum disorder (ASD) has increased substantially over the decades, and some environmental risk factors has been identified. However, the association between parental socioeconomic status (SES) and child's ASD is unknown. In this project, large birth cohort data set was analyzed to examine the association, and the odds of ASD with high SES was found to be significantly higher than that with low SES.


## Introduction

The prevalence of ASD has increased substantially over the past decades, from 6.7 in 2000 to 18.5 in 2016 per 1000 children, and ASD accounted for 7.7 million disability-adjusted life years (DALYs) in 2010, which was the leading mental cause of disability in children under five years old in terms of years lived with disability (YLDs).[1,2] Although up to 40–50% of the variance in ASD liability is determined by environmental factors and several pieces of evidence are presented for possible risk factors such as advanced parental age and maternal diseases, the association between SES and ASD is still to be clear and is inconsistent in previous studies.[2]

To address this question, I used and analyzed data set from large Japanese birth cohort, Japan Environment and Children’s Study (JECS). JECS is a nationwide epidemiological study involving 100,000 mother-child pairs living throughout Japan, and the data was collected in 15 regions throughout the country.[3] I used the data of 82413 children in JECS who responded to the 3-year-old questionnaire, which included a question about ASD diagnosis. 

Multiple separate logistic regression model were used with SES variables individually (household income, maternal and paternal education level) as explanatory variables and diagnosis of ASD as outcome variables, controlling for other possible risk factors such as paternal age, parental history of ASD and child's sex.  

Therefore I use multilevel models to see what and how factors may influence the number of comments of talks. Before that, I clean the data and combine some information collected from YouTube for same talk video.

## Method

### Data wrangling

I applied for the data provision to National Institute for Environmental Study in Japan, and the data set was extracted from JECS data server, which is not public for now. The raw data extracted from the JECS server included 104062 observations,  

Firstly, for some columns are 'dictionary' type so I need to clean them up, removing symbols that are useless. Secondly, I count the number of available languages, mutate it as a new column; Thirdly, I merged two data set into one and select the columns that I need; Finally, I transfered dates into POSIXct type by using Lubridate package.
Here are some explanations of columns:

| column names      | explanation |
| :--:              | :----- |
| title             | The title of talk|
| num_lang          | The number of available languages translations |
| comments          | The number of comments |
| duration_ted      | How long is the  video in  seconds |
| view_ted          | The number of views |
| categories        | The video was under which category on YouTube|
| english           | Indicate the native language is English or not|

Then, I got the cleaned data with 2165 observations and 32 variables. But I will choose only several variables to use.

### Exploratory Data Analysis

```{r include=FALSE}
eco2 <- eco %>% 
  mutate(Income=ifelse(eco$Income==1,"low",ifelse(eco$Income>=5,"high","middle"))) %>% 
  drop_na(ASD) %>% filter(sex!="3") %>% 
  mutate_at(c("ASD","sex","fASD","mASD","unit_no"),as.factor)%>%
  mutate(unit_no=fct_recode(unit_no,"Hokkaido"="10","Miyagi"="20","Fukushima"="30","Chiba"="40","Kanagawa"="50",
                        "Koshin"="61","Koshin"="62","Toyama"="70","Aichi"="80","Kyoto"="91","Kyoto"="92",
                        "Osaka"="100","Hyogo"="110","Tottori"="120","Kochi"="130","Fukuoka"="141","Fukuoka"="142",
                        "MinamiKyushu"="151","MinamiKyushu"="152","MinamiKyushu"="153")) %>%
  mutate(sex=fct_recode(sex,"male"="1","female"="2", "unknown"="3"))  
eco2$Income <- factor(eco2$Income, levels = c("low","middle","high"))
```



For the covariates, I used parental age, parental history of ASD, and child's sex, all of which are suspected as environmental risk factors of child's ASD.

For `views`, `comments` and some variables all have a large range and also if we see the density plots of them, there will be a long tale. Therefore, in order to make the plot more easy to read, I take log of these variables and draw some scatter plots to see if there is correlation between some variables with comments, since my question is how some factors effect the number of comments.  

```{r echo=FALSE, fig.height=4, fig.width= 10,fig.cap="Data was separate into English talks and not English talks. Different colors represent different categories.talke log of both comments and views to make it more easy to read."}
ggplot(data = talks)+
  aes(log(view_ted),log(comments))+
  geom_point(aes(color = categories),alpha = 0.3)+
  labs(title="number of visits vs number of comments",x="log(number of views)",y="log(number of comments)")+
  geom_smooth(aes(color = categories),method = "lm",se=F)+
  facet_grid(~english)

# Contingency table for fASD and ASD
prop.table(table(eco2$fASD, eco2$ASD), margin=1)*100
table <- table(eco2$fASD, eco2$ASD)
addmargins(table)

eco2 %>% drop_na(fASD,ASD) %>%
  ggplot(aes(x = as.factor(fASD), y = as.factor(ASD), fill = as.factor(ASD))) +
   geom_bar(stat='identity',position =position_stack(reverse =TRUE))

eco2%>% 
  drop_na(fASD,ASD) %>%
  ggplot()+
  geom_mosaic(aes(x = product(ASD, fASD), fill=ASD)) + 
  labs(title="Mosaic graph for child's ASD and father's ASD")

# Contingency table for mASD and ASD
prop.table(table(eco2$mASD, eco2$ASD), margin=1)*100
table <- table(eco2$mASD, eco2$ASD)
addmargins(table)

eco2%>%
  mutate_at(c("ASD","mASD"),factor) %>% 
  drop_na(ASD,mASD) %>%ggplot()+
  geom_mosaic(aes(x = product(ASD, mASD), fill=ASD)) + 
  labs(title="Mosaic graph for child's ASD and father's ASD")

# Contingency table for sex and ASD
prop.table(table(eco2$sex, eco2$ASD), margin=1)*100
table <- table(eco2$sex, eco2$ASD)
addmargins(table)

eco2%>%
  mutate_at(c("ASD","sex"),factor) %>% 
  drop_na(ASD,sex) %>%ggplot()+
  geom_mosaic(aes(x = product(ASD, sex), fill=ASD)) + 
   ylim(0.95, 1) +
  labs(title="Mosaic graph for child's ASD and father's ASD")

eco2%>%
  drop_na(ASD,Income) %>%
  ggplot()+
  geom_mosaic(aes(x = product(ASD, Income), fill=ASD)) + 
  coord_cartesian(ylim = c(0.95, 1))+
  scale_y_continuous( breaks = c(0.95,1), name = "Proportion of ASD")+
  facet_wrap( ~ unit_no, ncol=3)+
  labs(title="Mosaic graph for child's ASD and father's ASD")
```

Figure 1 show the relationship between number of views and comments. But this plot indicates that the speaker of majority of videos is speaking English, so I will consider only to fit model on English talks. And in the English group, it is obviously that with different contents the slope and intercept are slightly different, but the trend is almost the same, pointing to top-right. 

```{r echo=FALSE, fig.height=4, fig.width=10, fig.cap="correlation between duration and number of visits."}
ggplot(data = talks)+
  aes(log(duration_ted),log(comments))+
  geom_point(alpha = 0.3,aes(color = categories))+
  scale_fill_brewer(direction = -1)+
  labs(title = "duration vs number of comments",x="log(duration)",y="log(number of comments)")+
  geom_smooth(aes(color = categories),se=F,method = "lm")+
  facet_grid(~english)
```

Figure 2 is the same situation for English and not English group as above shows. So I will focus on the English plot. It also shows that in different categories the correlation between duration and number of comments are not same. And it is more clear than Figure 1 because some categories seems to have negative correlations but others have positive correlations.

```{r echo=FALSE, fig.height=4, fig.width=10, fig.cap="correlation between number of available languages and number of comments."}
ggplot(data = talks[-931,])+
  aes(log(num_lang),log(comments))+
  geom_point(alpha = 0.3,aes(color = categories))+
  labs(title = "number of available languages vs number of comments",
       x="log(number of available language)",
       y="log(number of comments)")+
  geom_smooth(aes(color = categories),se=F,method = "lm")+
  facet_grid(~english)
```

Just focus on the English group and see the regression lines on Figure 3, if the number of available language increases, the number of comments may increase. It makes sense for the more the number of available language, the more people from different countries will see the talks and leave their comments. Also different categories have different slopes and intercepts.

### Model Fitting

```{r include=FALSE}
talks <- talks[-931,]
talks <- subset(talks,english=="English")
fit4 <- lmer(log_comments~log_duration+log_views+log_numlang+(1+log_duration|categories)+(1+log_views|categories)+(1+log_numlang|categories),talks)
#confint(fit4)
coef(fit4)
summary(fit4)



fit.glmer1 <- glmer(ASD ~ Income + sex +fASD + mASD+ fathersage+ (1 + Income|unit_no), data = eco3, family = binomial)
summary(fit.glmer1)
coef(fit.glmer1)
binnedplot(fitted(fit.glmer1),resid(fit.glmer1,type="response"),main="Multilevel logistic regression")

```

Considering different categories, I will use multilevel model to fit the data. And for three continues variables-duration, number of language and duration-in order to match  the plots in EDA, I take log of them as predictors and also take log of number of comments as outcome. Since from EDA it is clear that talks in different categories have different correlation with variables, so I use varying slope and varying intercept in multilevel models. Besides, just as I mentioned before, English talks will only be taken into account. Below is the function:   

```{r eval=FALSE}
model <- lmer(log_comments~log_duration+log_views+log_numlang+(1+log_duration|categories)
              +(1+log_views|categories)+(1+log_numlang|categories),talks)
```

And to see the fixed effects below, all variables are significant at alpha = 0.05 level.

|                |Estimate   |Std. Error  |df        |t value |Pr(>&#124;t&#124;) |
|:---:           |:---:      |:---:       |:---:     |:---:   |:---:              |
|(Intercept)     |-12.93     |0.67        |16.75     |-19.43  |6.34e-13 ***       |
|log_duration    |0.79       |0.04        |24.53     |17.57   |2.10e-15 ***       |
|log_views       |0.33       |0.04        |12.21     |8.09    |2.99e-06 ***       |
|log_numlang     |2.33       |0.13        |10.98     |18.56   |1.21e-09 ***       |

## Result

## Model Coefficients

Just take some example here, for Entertainment category, we can conclude this formula: 

$$log(comments)= -12.70 + 0.77\cdot log(duration) + 0.32\cdot log(views) + 2.15\cdot log(numlang)$$
Because duration is counted in seconds, number of views always can be higher than 1000, and there are always more than 20 available languages, but number of comments always much less than number of views, so it makes sense that intercept in the formula is negative. But for log(duration), log(views) and log(numlang) can not be 0, it is hard to interpret. And all the parameters of three predictors are all bigger than 0, which means they all have positive impact on number of comments. For each 1% difference in duration, the predicted difference in comments is 0.77%. And the same for number of views and number of available languages.      

For different categories, the influence of each predictor is always not the same. For News & Politics, the Intercept is smaller than others, I think it may because when things related to politics, it is serious so many people will withhold their opinion. For Science & Technology, number of language have bigger influence than other categories, it may because we always need to learn the advanced technology from other countries and language is the biggest problem. So the number of languages is much more important in talks about Science and Technology. 

|                        |(Intercept) |log_duration |log_views  |log_numlang |
|:---:                   |:---:       |:---:        |:---:      |:---:       |
|Entertainment           |-12.70      |0.77         |0.32       |2.15        |
|News & Politics         |-14.37      |0.90         |0.38       |2.21        |
|People & Blogs          |-12.28      |0.73         |0.37       |2.47        |
|Science & Technology    |-13.37      |0.82         |0.21       |2.49        |

### Model Validation

```{r echo=FALSE, fig.height=2.5, fig.width=6, fig.cap="Residual plot and Q-Q plot."}
#binnedplot(fitted(fit4),resid(fit4))
re <- plot(fit4)
qq <- qqmath(fit4)
grid.arrange(re,qq,nrow=1)
```

```{r echo=FALSE, fig.height=2, fig.width=4, fig.cap="Residuals vs Leverage."}
ggplot(data.frame(lev=hatvalues(fit4),pearson=residuals(fit4,type="pearson")),
      aes(x=lev,y=pearson)) +
    geom_point() +
    theme_bw()
```
   
From the Residual plots in Figure 4 we can see that the mean of residuals is almost 0, but dots reduce on the right and left of the plot since the number of samples are small there, so it makes sense. And for the Q-Q plot in Figure 4, majority dots are on the lines so the normality is good. Figure 5 shows that there are not obvious leverage point.

## Discussion

The estimates are all reasonable in some extents. The longer the duration, the more information the speaker conveys, so people are more likely to have some perspectives; The larger the number of views, the more people will debate and have some comments; The more the number of available languages, the more people will have access to these talks, so people all over the world will talk together. Due to features of different categories, the different estimates of three predictors are also convincing.     

The result of model almost matches well for different categories in EDA, but there are still some problems. In EDA part we see that some lines have negative slopes which means that the increasing in duration will make the number of comments decrease. But because for majority of categories, duration have a positive impact on number of comments, so although I use multilevel model with varying slope to fit the data, all the estimates of duration indicate that it has positive influence on comments for all categories.  

I only use three variables to predict the outcome, but there are still some variables that may have big effects on comments, such as who is the speaker, the occupation of the speaker and the contents of talks. Actually there is a column contains the information of occupation, but it seems that the occupation in that column is too specific, so for further improvement, I will clean them up, and separate them into several categories, then add them into the model.

## Citation

1. Center for Disease Control and Prevention: Autism Spectrum Disorder (ASD)
https://www.cdc.gov/ncbddd/autism/data.html  

2. Modabbernia, A., Velthorst, E., & Reichenberg, A. (2017). Environmental risk factors for autism: an evidence-based review of systematic reviews and meta-analyses. Molecular autism, 8, 13. 
https://doi.org/10.1186/s13229-017-0121-4  

3. National Institute for Environmental Study in Japan: Japan Environment and Children’s Study
https://www.env.go.jp/chemi/ceh/en/index.html


University of Wisconsin. Mixed Models: Diagnostics and Inference. https://www.ssc.wisc.edu/sscc/pubs/MM/MM_DiagInfer.html

Hadley Wickham (2017). tidyverse: Easily Install and Load the ‘Tidyverse’. R package version 1.2.1.
https://CRAN.R-project.org/package=tidyverse

Rune Haubo Bojesen Christensen. lmerTest: Tests in Linear Mixed Effects Models. R package version 3.1.3. https://CRAN.R-project.org/package=lmerTest
    

\newpage
## Appendix
### More EDA
```{r echo=FALSE, fig.cap="distribution plots for number of language, number of comments, number of views and duration"}
p1 <- ggplot(data = talks) + 
  aes(x=num_lang) + 
  geom_histogram(binwidth = 2,fill="steelblue")+
  labs(title = "distribution of available languages",x = "number of available languages")

p2 <- ggplot(data = talks) + 
  aes(comments) + 
  geom_histogram(binwidth = 100,fill="darkseagreen")+
  xlim(0,2000)+
  labs(title = "distribution of comments",x = "number of comments")

p3 <- ggplot(data = talks) + 
  aes(view_ted) + 
  geom_histogram(binwidth = 500000,fill="darkorange2")+
  xlim(0,20000000)+
  labs(title = "distribution of views",x = "number of views")

p4 <- ggplot(data = talks) + 
  aes(duration_ted/60) + 
  geom_histogram(binwidth = 1,fill="hotpink3")+
  labs(title = "distribution of duration",x = "duration/min")
grid.arrange(p1,p2,p3,p4,nrow=2)
```

```{r echo=FALSE, fig.cap="plots for count of category"}
##category
talks %>%
  count(categories, sort = TRUE) %>%
  mutate(event = reorder(categories, n)) %>%
  ggplot(aes(n, categories)) +
  geom_col(fill="tan4") +
  labs(y = NULL)
```

\newpage
### Full Results
Random effects of model
```{r echo=FALSE}
quantile(eco2$Income, probs = c(20, 40, 50, 60, 80, 100)/100, na.rm = TRUE)
ranef(fit.glmer1)
```
Fixed effects of model
```{r echo=FALSE}
fixef(fit.glmer1)
```
Coefficients of model
```{r echo=FALSE}
coef(fit4)
```


