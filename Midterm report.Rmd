---
title: "Report of MA678 Midterm Project"
author: "Kosuke Sasaki"
date: "2021/12/11"
output:
  pdf_document:
    includes:
      in_header: style.sty
  html_document: default
  word_document: default
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
Sys.setenv("LANGUAGE" = "EN")
Sys.setlocale("LC_ALL", "C")
library(openxlsx)
library(ggmosaic)
library(tidyverse)
library(stringr)
library(rstanarm)
library(knitr)
library(magrittr)
library(kableExtra)
library(gridExtra)
library(tidytext)
library(lubridate)
library(car) 
library(gvlma)
library(lme4)
library(arm)
library(lmerTest)
library(lattice)
library(ggplot2)
library(scales)
library(ggpubr)
library(languageR)
library(plyr)
eco <- read.xlsx("Final dataset original.xlsx",sheet=1)
```

## Abstract

Autism spectrum disorder (ASD) has increased substantially over the decades, and some environmental risk factors has been identified. However, the association between parental socioeconomic status (SES) and child's ASD is unknown. In this project, large birth cohort data set was analyzed to examine the association, and the odds of ASD with high SES was found to be significantly higher than that with low SES.


## Introduction

The prevalence of ASD has increased substantially over the past decades, from 6.7 in 2000 to 18.5 in 2016 per 1000 children, and ASD accounted for 7.7 million disability-adjusted life years (DALYs) in 2010, which was the leading mental cause of disability in children under five years old in terms of years lived with disability (YLDs).[1,2] Although up to 40–50% of the variance in ASD liability is determined by environmental factors and several pieces of evidence are presented for possible risk factors such as advanced parental age and maternal diseases, the association between SES and ASD is still to be clear and is inconsistent in previous studies.[2]

To address this research question, I used and analyzed data set from large Japanese birth cohort, Japan Environment and Children’s Study (JECS). JECS is a nationwide epidemiological study involving 100,000 mother-child pairs living throughout Japan, and the data was collected in 15 regions throughout the country.[3] I used the data of 82232 children in JECS who responded to the 3-year-old questionnaire, which included a question about ASD diagnosis, and fit the multiple logistic regression model to see if SES is related to child's ASD. 

## Method

### Data wrangling

I applied for the data provision to National Institute for Environmental Study in Japan, and the data set was extracted from JECS data server, which is not public for now. Two raw data sets were extracted from the JECS server which included 104062 observations and different variables; one includes id, district, child's sex, Income, parental age and parental ASD history, and the other includes id and child's ASD.  

After I merged the two data sets based on id as an identifier, I recategorize income values to align with the objective of this project. For the income category, there were originally nine levels of classification, from Category 1 which corresponds to an annual income of less than 2 million yen, to Category 9 which corresponds to more than 20 million yen. In this project, I will look for the relationship between SES and ASD, and particularly see if low-SES or high-SES could be related with high ratio of ASD. In this perspective, I need to recategorize income into 3 levels of classification, low, middle and high, as a proxy of SES, and I defined the categories below the bottom quintile of income as low income, the categories above the top quintile of income as high income and the others as middle income, which also follows the income category of Cabinet Office in Japan.[4]   

Secondly, I assumed missing completely at random and removed observations with missing value for ASD, sex, Income, paternal age, and parental ASD and with sex value of 3 categorized as "unknown", which leads to 40438 observations from original 104062 observations. Finally, I converted variable type for "ASD", "sex","fASD","mASD","unit_no" from numeric to factor, assigned appropriate label or name to variable name and values, and assigned levels in ascending order to income category. Each variable name and explanation used in this project is shown below.


| column names      | explanation |
| :--:              | :----- |
| NO                | participant's id |
| district          | location where the participant's data is collected (one of 15 districts) |
| ASD               | whether the child develops ASD |
| sex               | child's sex (male or female) |
| Income            | family's income (low, middle, or high) |
| fathersage        | paternal age at the time of delivery |
| momsage           | maternal age at the time of delivery |
| fASD              | whether the father develops ASD |
| mASD              | whether the mother develops ASD |

### Exploratory Data Analysis

```{r include=FALSE}
eco2 <- eco %>% 
  mutate(Income=ifelse(eco$Income==1,"low",ifelse(eco$Income>=5,"high","middle"))) %>% 
  drop_na(ASD,sex,mASD,fASD,fathersage,Income) %>% filter(sex!="3") %>% 
  mutate_at(c("ASD","sex","fASD","mASD","unit_no"),as.factor)%>%
  mutate(unit_no=fct_recode(unit_no,"Hokkaido"="10","Miyagi"="20","Fukushima"="30","Chiba"="40","Kanagawa"="50",
                        "Koshin"="61","Koshin"="62","Toyama"="70","Aichi"="80","Kyoto"="91","Kyoto"="92",
                        "Osaka"="100","Hyogo"="110","Tottori"="120","Kochi"="130","Fukuoka"="141","Fukuoka"="142",
                        "MinamiKyushu"="151","MinamiKyushu"="152","MinamiKyushu"="153")) %>%
  mutate(sex=fct_recode(sex,"male"="1","female"="2")) %>% 
  mutate(ASD=fct_recode(ASD,"child w/o ASD"="0","child with ASD"="1")) %>% 
  mutate(mASD=fct_recode(mASD,"mother w/o ASD"="0","mother with ASD"="1")) %>% 
  mutate(fASD=fct_recode(fASD,"father w/o ASD"="0","father with ASD"="1"))%>%
  rename(c("unit_no" = "district"))
eco2$Income <- factor(eco2$Income, levels = c("low","middle","high"))

```
Contingency table for child's sex and ASD is shown below. ASD seems to be more frequent for male compared to female in this cohort, and this is already proved and accepted in the world.[5]

|sex|Child with ASD|Child w/o ASD|Total
|:--|:--|:---|:--|
Male|20501 (99.4%)|131 (0.6%)|20632
Female|19762 (99.8%)|44 (0.2%)|19806
\hline Sum|40263 (99.6%)|175 (0.4%)|40438
  
Contingency tables for parental ASD and child's ASD are shown below. The prevalence of ASD in parents of both sexes is less than 0.03%, which is extremely low compared to the prevalence of 0.4% in children. Although parental ASD and child's ASD seem to be related, as one out of 20 parents with ASD has a child with ASD, there is an uncertainty due to the very small sample size of parental ASD.  

| |Child with ASD|Child w/o ASD|Total
|:--|:--|:---|:--|
Mother w/o ASD|40254 (99.6%)|174 (0.4%)|40428
Mother with ASD|9 (90.0%)|1 (10.0%)|10
\hline Sum|40263 (99.6%)|175 (0.4%)|40438  


| |Child with ASD|Child w/o ASD|Total
|:--|:--|:---|:--|
Father w/o ASD|40254 (99.6%)|175 (0.4%)|40429
Father with ASD|9 (100.0%)|0 (0.0%)|9
\hline Sum|40263 (99.6%)|175 (0.4%)|40438 

Then, I will look at the mosaic graph for child's ASD and Income grouped by district as below.  

```{r echo=FALSE, fig.height=4, fig.width= 10,fig.cap="Mosaic graph for child's ASD and Income"}
# Mosaic graph for Income and ASD grouped by unit
eco2%>%
  ggplot()+
  geom_mosaic(aes(x = product(ASD, Income), fill=ASD)) + 
  coord_cartesian(ylim = c(0.95, 1))+
  scale_y_continuous( breaks = c(0.95,1), name = "Prevalence of ASD")+
  facet_wrap( ~ district, ncol=3)+
  labs(title="Fig1. Mosaic graph for child's ASD and Income")
```

Figure 1 shows the prevalence of ASD by income, for each of the 15 regions. Here, note that the y-axis starts at 0.95 because the prevalence of ASD is very low. Although there is variation across regions, the prevalence of ASD in the low-income category seems to be generally lower than in other income categories.  
Finally, I look at the relationship between ASD and paternal age as below.  

```{r echo=FALSE, fig.height=4, fig.width= 10,fig.cap="Density plot for child's ASD and paternal age"}

# Density plot for paternal age and ASD 
mu <- ddply(eco2, "ASD", summarise, grp.mean=mean(fathersage))
ggplot(eco2, aes(x=fathersage, fill=ASD)) +
  geom_density(alpha=0.4)+
  geom_vline(data=mu, aes(xintercept=grp.mean, color=ASD),
             linetype="dashed")+
  annotate("text", x=28, y=0.075, label="mean age=33.0",colour="red",size=4)+
  annotate("text", x=40, y=0.075, label="mean age=34.9",colour="blue",size=4)+
  labs(title="Fig2. Density plot for child's ASD and paternal age")
```

Figure 2 shows density plot for the paternal age by child's ASD. Based on the graph, paternal age with a ASD child seems to be higher than that with a non-ASD child.

### Model Fitting

```{r include=FALSE}
fit <- glmer(ASD ~ Income + sex +fASD + mASD+ fathersage + (1 + Income|district), data = eco2, family = binomial)
summary(fit)
coef(fit)
binnedplot(fitted(fit),resid(fit,type="response"),main="Multilevel logistic regression")
pairscor.fnc(ranef(fit)$district)
```

I will use the multilevel logistic regression model to fit the data, selecting ASD as an outcome and Income, sex, parental ASD, and paternal age as predictors. All the predictors excluding income are thought of as risk factors for ASD.[1] As the maternal age is highly correlated with paternal age (Appendix), which will make the model unstable if included, and is still to be investigated as a risk factor for ASD, I will not include maternal age in this model.[6]  
Based on the EDA, prevalence of ASD by income seems to be different in different district. In addition, the diagnostic rate of ASD could differ in different districts which have different facilities and diagnostic skills, the improvement of which is partly attributable to the rapid increase of ASD, I assume random effect for the intercept as well as income coefficient. On the other hand, the effect of child's sex, parental ASD, and paternal age on development of ASD is through biological pathway. Thus their effects can be thought of as fixed one, and not affected by district. Then I fit the model to the data as below.  

```{r eval=FALSE}
fit <- glmer(ASD ~ Income + sex +fASD + mASD+ fathersage + (1 + Income|district), 
             data = eco2, family = binomial)
```


## Result

Fixed effects and fitted model are shown below.  

|                |Estimate   |Std. Error  |z value |Pr(>&#124;z&#124;) |
|:---:           |:---:      |:---:       |:---:   |:---:              |
|(Intercept)     |-10.17     |1.74        |-5.86   |4.63e-09 ***       |
|Incomemiddle    |3.31       |1.71        |1.94    |0.05238  .         |
|Incomehigh      |3.51       |1.72        |2.04    |0.04118  *         |
|sexfemale       |-1.06      |0.18        |-6.05   |1.46e-09 ***       |
|father with ASD |-28.13     |6.29e+06    |0.000   |1.00000            |
|mother with ASD |3.47       |1.13        |3.06    |0.00221 **         |
|fathersage      |0.05       |1.28e-02    |3.91    |9.36e-05 ***       |  


$$\begin{split}logit(\pi)= -10.17 + 3.31\ast (MiddleIncome) + 3.51\ast (HighIncome) - 1.06\ast (female) -\\28.13\ast (paternalASD) + 3.47\ast (maternalASD) + 0.05\ast (paternalage)\end{split}$$
The effect estimates of high income as well as sex, maternal ASD and paternal age were significant at the significance level of 0.05. For example, the interpretation for high income and paternal age are as follows; the odds of children with high family income developing ASD is exp(3.51)=33.4 times as high as that with low income, holding other predictors and district constant; the odds of children whose father is older by one year developing ASD is exp(0.05)=1.05 times as high as that of children whose father is younger.  
Sample of effect estimates including random effect are shown below. In Hokkaido and Fukushima, though there are some variation for intercept and income effect, those are close each other and also close to fixed effect estimates. However, in Kanagawa the intercept is far larger than the other ones, and the income effect is even reversed.
```{r echo=FALSE}
kable(coef(fit)[["district"]][c(1,3,5),]) %>% 
  kable_styling(latex_options="scale_down") %>%
  kable_styling(latex_options = "HOLD_position")
```

## Discussion

All the covariates except for income and paternal ASD were significant. Those are 

The estimates are all reasonable in some extents. The longer the duration, the more information the speaker conveys, so people are more likely to have some perspectives; The larger the number of views, the more people will debate and have some comments; The more the number of available languages, the more people will have access to these talks, so people all over the world will talk together. Due to features of different categories, the different estimates of three predictors are also convincing.     

The result of model almost matches well for different categories in EDA, but there are still some problems. In EDA part we see that some lines have negative slopes which means that the increasing in duration will make the number of comments decrease. But because for majority of categories, duration have a positive impact on number of comments, so although I use multilevel model with varying slope to fit the data, all the estimates of duration indicate that it has positive influence on comments for all categories.  

I only use three variables to predict the outcome, but there are still some variables that may have big effects on comments, such as who is the speaker, the occupation of the speaker and the contents of talks. Actually there is a column contains the information of occupation, but it seems that the occupation in that column is too specific, so for further improvement, I will clean them up, and separate them into several categories, then add them into the model.

## Citation

1. Center for Disease Control and Prevention: Autism Spectrum Disorder (ASD)
https://www.cdc.gov/ncbddd/autism/data.html  

2. Modabbernia, A., Velthorst, E., & Reichenberg, A. (2017). Environmental risk factors for autism: an evidence-based review of systematic reviews and meta-analyses. Molecular autism, 8, 13. 
https://doi.org/10.1186/s13229-017-0121-4  

3. National Institute for Environmental Study in Japan: Japan Environment and Children’s Study
https://www.env.go.jp/chemi/ceh/en/index.html

4. Cabinet Office in Japan: Annual Report on the Japanese Economy and Public Finance. https://www5.cao.go.jp/j-j/wp/wp-je09/pdf/09p03022.pdf

5. Center for Disease Control and Prevention: What is Autism Spectrum Disorder? https://www.cdc.gov/ncbddd/autism/facts.html

6. Kelly, B., Williams, S., Collins, S., Mushtaq, F., Mon-Williams, M., Wright, B., Mason, D., & Wright, J. (2019). The association between socioeconomic status and autism diagnosis in the United Kingdom for children aged 5–8 years of age: Findings from the Born in Bradford cohort. Autism, 23(1), 131–140. https://doi.org/10.1177/1362361317733182


\newpage
## Appendix
### More EDA
```{r echo=FALSE, fig.cap="distribution plots for number of language, number of comments, number of views and duration"}
p1 <- ggplot(data = talks) + 
  aes(x=num_lang) + 
  geom_histogram(binwidth = 2,fill="steelblue")+
  labs(title = "distribution of available languages",x = "number of available languages")

p2 <- ggplot(data = talks) + 
  aes(comments) + 
  geom_histogram(binwidth = 100,fill="darkseagreen")+
  xlim(0,2000)+
  labs(title = "distribution of comments",x = "number of comments")

p3 <- ggplot(data = talks) + 
  aes(view_ted) + 
  geom_histogram(binwidth = 500000,fill="darkorange2")+
  xlim(0,20000000)+
  labs(title = "distribution of views",x = "number of views")

p4 <- ggplot(data = talks) + 
  aes(duration_ted/60) + 
  geom_histogram(binwidth = 1,fill="hotpink3")+
  labs(title = "distribution of duration",x = "duration/min")
grid.arrange(p1,p2,p3,p4,nrow=2)
```

```{r echo=FALSE, fig.cap="plots for count of category"}
##category
talks %>%
  count(categories, sort = TRUE) %>%
  mutate(event = reorder(categories, n)) %>%
  ggplot(aes(n, categories)) +
  geom_col(fill="tan4") +
  labs(y = NULL)
```

### Model Validation

```{r echo=FALSE, fig.height=2.5, fig.width=6, fig.cap="Residual plot and Q-Q plot."}
#binnedplot(fitted(fit4),resid(fit4))
re <- plot(fit4)
qq <- qqmath(fit4)
grid.arrange(re,qq,nrow=1)
```

```{r echo=FALSE, fig.height=2, fig.width=4, fig.cap="Residuals vs Leverage."}
ggplot(data.frame(lev=hatvalues(fit4),pearson=residuals(fit4,type="pearson")),
      aes(x=lev,y=pearson)) +
    geom_point() +
    theme_bw()
```
   
From the Residual plots in Figure 4 we can see that the mean of residuals is almost 0, but dots reduce on the right and left of the plot since the number of samples are small there, so it makes sense. And for the Q-Q plot in Figure 4, majority dots are on the lines so the normality is good. Figure 5 shows that there are not obvious leverage point.

\newpage
### Full Results
Random effects of model
```{r echo=FALSE}
quantile(eco2$Income, probs = c(20, 40, 50, 60, 80, 100)/100, na.rm = TRUE)
ranef(fit.glmer1)
```
Fixed effects of model
```{r echo=FALSE}
fixef(fit.glmer1)
```
Coefficients of model
```{r echo=FALSE}
coef(fit)
```


Then, I got the cleaned data with 2165 observations and 32 variables. But I will choose only several variables to use.

Multiple separate logistic regression model were used with SES variables individually (household income, maternal and paternal education level) as explanatory variables and diagnosis of ASD as outcome variables, controlling for other possible risk factors such as paternal age, parental history of ASD and child's sex.  

Therefore I use multilevel models to see what and how factors may influence the number of comments of talks. Before that, I clean the data and combine some information collected from YouTube for same talk video.

```{r echo=FALSE, fig.height=4, fig.width= 10,fig.cap="Data was separate into English talks and not English talks. Different colors represent different categories.talke log of both comments and views to make it more easy to read."}
ggplot(data = talks)+
  aes(log(view_ted),log(comments))+
  geom_point(aes(color = categories),alpha = 0.3)+
  labs(title="number of visits vs number of comments",x="log(number of views)",y="log(number of comments)")+
  geom_smooth(aes(color = categories),method = "lm",se=F)+
  facet_grid(~english)

# Contingency table for fASD and ASD
prop.table(table(eco2$fASD, eco2$ASD), margin=1)*100
table <- table(eco2$fASD, eco2$ASD)
addmargins(table)

eco2 %>% drop_na(fASD,ASD) %>%
  ggplot(aes(x = as.factor(fASD), y = as.factor(ASD), fill = as.factor(ASD))) +
   geom_bar(stat='identity',position =position_stack(reverse =TRUE))

eco2%>% 
  drop_na(fASD,ASD) %>%
  ggplot()+
  geom_mosaic(aes(x = product(ASD, fASD), fill=ASD)) + 
  labs(title="Mosaic graph for child's ASD and father's ASD")

# Contingency table for mASD and ASD
prop.table(table(eco2$mASD, eco2$ASD), margin=1)*100
table <- table(eco2$mASD, eco2$ASD)
addmargins(table)

eco2%>%
  mutate_at(c("ASD","mASD"),factor) %>% 
  drop_na(ASD,mASD) %>%ggplot()+
  geom_mosaic(aes(x = product(ASD, mASD), fill=ASD)) + 
  labs(title="Mosaic graph for child's ASD and father's ASD")

# Contingency table for sex and ASD
prop.table(table(eco2$sex, eco2$ASD), margin=1)*100
table <- table(eco2$sex, eco2$ASD)
addmargins(table)

eco2%>%
  mutate_at(c("ASD","sex"),factor) %>% 
  drop_na(ASD,sex) %>%ggplot()+
  geom_mosaic(aes(x = product(ASD, sex), fill=ASD)) + 
   ylim(0.95, 1) +
  labs(title="Mosaic graph for child's ASD and father's ASD")

# Mosaic graph for Income and ASD grouped by unit
eco2%>%
  drop_na(ASD,Income) %>%
  ggplot()+
  geom_mosaic(aes(x = product(ASD, Income), fill=ASD)) + 
  coord_cartesian(ylim = c(0.95, 1))+
  scale_y_continuous( breaks = c(0.95,1), name = "Proportion of ASD")+
  facet_wrap( ~ district, ncol=3)+
  labs(title="Mosaic graph for child's ASD and father's ASD")

# Boxplot for paternal age and ASD 
ggplot(eco2, aes(x=district, y=fathersage, fill=ASD)) + 
    geom_boxplot()
ggplot(eco2, aes(x=ASD, y=fathersage, fill=ASD)) + 
    geom_boxplot()

# Boxplot for maternal age and ASD 
ggplot(eco2, aes(x=district, y=momsage, fill=ASD)) + 
    geom_boxplot()
ggplot(eco2, aes(x=ASD, y=momsage, fill=ASD)) + 
    geom_boxplot()

#Correlation between parental age
ggscatter(eco2, x = "fathersage", y = "momsage", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Paternal age", ylab = "Maternal age")

res <- cor.test(eco3$momsage, eco3$fathersage, 
                    method = "pearson")
res
res$p.value
res$estimate

```
